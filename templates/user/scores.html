{% extends "base.html" %}

{% block title %}My Scores - Quiz Master{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>My Quiz Scores</h1>
    <a href="{{ url_for('user_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Score History</h5>
            </div>
            <div class="card-body">
                {% if scores %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Quiz</th>
                                    <th>Subject</th>
                                    <th>Date Attempted</th>
                                    <th>Score</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for score in scores %}
                                    {% set percentage = (score.total_scored / score.total_questions) * 100 %}
                                    <tr>
                                        <td>{{ score.quiz.chapter.name }}</td>
                                        <td>{{ score.quiz.chapter.subject.name }}</td>
                                        <td>{{ score.time_stamp_of_attempt.strftime('%d-%m-%Y %H:%M') }}</td>
                                        <td>{{ score.total_scored }}/{{ score.total_questions }}</td>
                                        <td>
                                            <div class="progress">
                                                <!-- We'll replace this with JavaScript -->
                                                <div id="progress-{{ loop.index }}" 
                                                     data-percentage="{{ percentage }}"
                                                     class="progress-bar">
                                                    {{ percentage|round|int }}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        You haven't attempted any quizzes yet.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Performance Summary</h5>
            </div>
            <div class="card-body">
                {% if scores %}
                    <canvas id="scoreDistributionChart"></canvas>
                    
                    {% set excellent_count = 0 %}
                    {% set good_count = 0 %}
                    {% set average_count = 0 %}
                    {% set poor_count = 0 %}
                    
                    {% for score in scores %}
                        {% set percentage = (score.total_scored / score.total_questions) * 100 %}
                        {% if percentage >= 80 %}
                            {% set excellent_count = excellent_count + 1 %}
                        {% elif percentage >= 60 %}
                            {% set good_count = good_count + 1 %}
                        {% elif percentage >= 40 %}
                            {% set average_count = average_count + 1 %}
                        {% else %}
                            {% set poor_count = poor_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    
                    <div class="mt-4">
                        <h6>Performance Breakdown</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Excellent (80-100%)
                                <span class="badge bg-success rounded-pill">{{ excellent_count }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Good (60-79%)
                                <span class="badge bg-info rounded-pill">{{ good_count }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Average (40-59%)
                                <span class="badge bg-warning rounded-pill">{{ average_count }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Poor (0-39%)
                                <span class="badge bg-danger rounded-pill">{{ poor_count }}</span>
                            </li>
                        </ul>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        No data available for performance summary.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Hidden data elements for chart -->
<div id="chart-data" 
     data-excellent="{{ excellent_count if scores else 0 }}"
     data-good="{{ good_count if scores else 0 }}"
     data-average="{{ average_count if scores else 0 }}"
     data-poor="{{ poor_count if scores else 0 }}"
     data-has-scores="{{ 'true' if scores else 'false' }}">
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set up progress bars with correct classes and styles
    var progressBars = document.querySelectorAll('[id^="progress-"]');
    progressBars.forEach(function(bar) {
        var percentage = parseFloat(bar.getAttribute('data-percentage'));
        
        // Set width
        bar.style.width = percentage + '%';
        
        // Set attributes
        bar.setAttribute('aria-valuenow', percentage);
        bar.setAttribute('aria-valuemin', 0);
        bar.setAttribute('aria-valuemax', 100);
        
        // Set color class based on percentage
        if (percentage >= 80) {
            bar.classList.add('bg-success');
        } else if (percentage >= 60) {
            bar.classList.add('bg-info');
        } else if (percentage >= 40) {
            bar.classList.add('bg-warning');
        } else {
            bar.classList.add('bg-danger');
        }
    });
    
    // Check if we have scores data
    var dataElement = document.getElementById('chart-data');
    var hasScores = dataElement.getAttribute('data-has-scores') === 'true';
    
    if (hasScores) {
        // Get chart data
        var chartData = {
            excellent: parseInt(dataElement.getAttribute('data-excellent') || 0),
            good: parseInt(dataElement.getAttribute('data-good') || 0),
            average: parseInt(dataElement.getAttribute('data-average') || 0),
            poor: parseInt(dataElement.getAttribute('data-poor') || 0)
        };
        
        var ctx = document.getElementById('scoreDistributionChart').getContext('2d');
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Excellent (80-100%)', 'Good (60-79%)', 'Average (40-59%)', 'Poor (0-39%)'],
                datasets: [{
                    data: [
                        chartData.excellent,
                        chartData.good,
                        chartData.average,
                        chartData.poor
                    ],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(23, 162, 184, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(220, 53, 69, 0.7)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(23, 162, 184, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}